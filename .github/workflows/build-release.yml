# Build and Release GeoMesa Artifacts
#
# USE CASE:
#   Full build and deployment of GeoMesa release artifacts. Compiles the project,
#   creates a GitHub release, uploads binary distributions, and deploys Maven
#   artifacts to the selected repository (GitHub Packages and/or Artifactory).
#
# PREREQUISITES:
#   - Must be triggered from a release tag (e.g., geomesa-5.4.1-raft)
#   - For GitHub Packages: GITHUB_TOKEN (automatic)
#   - For Artifactory: ARTIFACTORY_USERNAME and ARTIFACTORY_PASSWORD secrets must be configured
#
# OUTPUTS:
#   - GitHub Release with binary tarballs and staging repo archives
#   - Maven artifacts deployed to selected repository
#
# RETRY:
#   If deployment fails after a successful build, use the 'publish-release' workflow
#   to retry deployment without rebuilding.

name: build-release

on:
  workflow_dispatch:
    inputs:
      modules:
        description: 'Optional Maven reactor options to build specific modules. Examples: "-pl geomesa-kafka/geomesa-kafka-datastore -am" (build kafka-datastore and dependencies), "-rf :geomesa-kafka_2.13" (resume from kafka module). Leave empty to build all modules.'
        required: false
        default: ''
      skip_create_release:
        description: 'Skip creating GitHub release. Use when re-running after a partial failure where the release already exists.'
        type: boolean
        required: false
        default: false
      deploy_target:
        description: 'Target Maven repository for artifact deployment. "github" = GitHub Packages, "artifactory" = CBC2 Artifactory, "both" = deploy to both repositories.'
        type: choice
        required: true
        default: 'github'
        options:
          - github
          - artifactory
          - both

permissions:  # added using https://github.com/step-security/secure-repo
  contents: read
  packages: write

env:
  JAVA_VERSION: 17
  MAVEN_CLI_OPTS: -Dhttp.keepAlive=false -Dmaven.wagon.http.pool=false --batch-mode -Dlicense.skip=true
  MAVEN_RELEASE_ARGS: clean deploy -Prelease,docs,python -Dmaven.test.skip -Daether.checksums.algorithms=MD5,SHA-1,SHA-256
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  create-github-release:
    name: create-github-release
    if: ${{ github.event.inputs.skip_create_release != 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - name: Create GitHub release
        run: |
          version="${GITHUB_REF_NAME#geomesa-}"
          gh release create ${GITHUB_REF_NAME} \
            --repo ${GITHUB_REPOSITORY} \
            --title "GeoMesa ${version}" \
            --notes "[Release notes](https://geomesa.atlassian.net/wiki/display/GEOMESA/GeoMesa+${version}+Release+Notes)"\
            --prerelease \
            --verify-tag
  build:
    name: build-release / ${{ matrix.scala-version }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    needs: create-github-release
    if: ${{ always() && (needs.create-github-release.result == 'success' || needs.create-github-release.result == 'skipped') }}
    strategy:
      fail-fast: false
      matrix:
        scala-version: [ "2.12", "2.13" ]
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
        with:
          distribution: temurin
          java-version: "${{ env.JAVA_VERSION }}"
          server-id: github
          settings-path: ${{ github.workspace }}
      - uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 #v6.1.0
        with:
          python-version: "3.10"
      - name: Install docs dependencies
        run: pip install -r docs/requirements.txt
      - name: Set Scala version
        run: ./build/scripts/change-scala-version.sh ${{ matrix.scala-version }}
      - name: Build
        id: build
        continue-on-error: true
        run: |
          set -o pipefail
          mvn $MAVEN_RELEASE_ARGS $MAVEN_CLI_OPTS -DaltDeploymentRepository=local::file:./staging-repo ${{ github.event.inputs.modules }} | tee -a build_${{ matrix.scala-version }}.log
      - name: Build (retry)
        if: steps.build.outcome=='failure'
        run: |
          set -o pipefail
          # retry if the failure was due to transient download errors from maven central
          if grep -q -e 'Could not transfer artifact' -e 'Failed to read artifact descriptor' build_${{ matrix.scala-version }}.log; then
            RESUME_FROM="$({ grep --text 'mvn <args> -rf ' build_${{ matrix.scala-version }}.log || test $? = 1; } | tail -n1 | sed 's/.*-rf/-rf/')"
            mvn $MAVEN_RELEASE_ARGS $MAVEN_CLI_OPTS -DaltDeploymentRepository=local::file:./staging-repo ${{ github.event.inputs.modules }} $RESUME_FROM | tee -a build_${{ matrix.scala-version }}.log
          else
            exit 1
          fi
      - name: Upload release artifacts
        run: |
          echo "Copying release artifacts"
          find ./staging-repo/ -name 'maven-metadata.xml*' -exec rm {} \;
          tar -czf "${GITHUB_REF_NAME}_${{ matrix.scala-version }}-staging.tgz" -C ./staging-repo/ .
          gh release upload "${GITHUB_REF_NAME}" \
              --repo ${GITHUB_REPOSITORY} \
              "${GITHUB_REF_NAME}_${{ matrix.scala-version }}-staging.tgz"
          while IFS= read -r -d '' file; do
            pushd "$(dirname "$file")" >/dev/null
            sha256sum "$(basename "$file")" > "$(basename "$file").sha256"
            popd >/dev/null
            # GitHub CLI does not respect their own rate limits: https://github.com/cli/cli/issues/9586
            sleep 1
            gh release upload "${GITHUB_REF_NAME}" \
              --repo ${GITHUB_REPOSITORY} \
              "${file}" "${file}.sha256"
          done < <(find geomesa-* -name '*-bin.tar.gz' -print0)
      - name: Publish to GitHub Packages
        if: ${{ github.event.inputs.deploy_target == 'github' || github.event.inputs.deploy_target == 'both' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mvn deploy -Pgithub,release -Dmaven.test.skip -Dmaven.install.skip=true \
            --settings ${{ github.workspace }}/settings.xml \
            $MAVEN_CLI_OPTS ${{ github.event.inputs.modules }}
      - name: Create Artifactory settings.xml
        if: ${{ github.event.inputs.deploy_target == 'artifactory' || github.event.inputs.deploy_target == 'both' }}
        run: |
          cat > ${{ github.workspace }}/settings-artifactory.xml << 'EOF'
          <settings>
            <servers>
              <server>
                <id>artifactory</id>
                <username>${{ secrets.ARTIFACTORY_USERNAME }}</username>
                <password>${{ secrets.ARTIFACTORY_PASSWORD }}</password>
              </server>
            </servers>
          </settings>
          EOF
      - name: Publish to Artifactory
        if: ${{ github.event.inputs.deploy_target == 'artifactory' || github.event.inputs.deploy_target == 'both' }}
        run: |
          mvn deploy -Partifactory,release -Dmaven.test.skip -Dmaven.install.skip=true \
            --settings ${{ github.workspace }}/settings-artifactory.xml \
            $MAVEN_CLI_OPTS ${{ github.event.inputs.modules }}
      - name: Upload job logs
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: build-log-${{ matrix.scala-version }}
          retention-days: 90 # max default
          path: build_${{ matrix.scala-version }}.log
